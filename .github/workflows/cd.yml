name: CD - Déploiement

# Déclenchement : uniquement sur main
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permet le déclenchement manuel

env:
  DOCKER_IMAGE: leaf-disease-classification
  REGISTRY: ghcr.io

jobs:
  deploy:
    name: Déploiement
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Installation des dépendances
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Vérification de la configuration
      run: |
        echo "============================================"
        echo "VÉRIFICATION DE LA CONFIGURATION"
        echo "============================================"
        python -c "from src.data.dataset import load_config; config = load_config(); print('✅ Configuration OK')"
    
    - name: Test de création du modèle
      run: |
        echo "============================================"
        echo "TEST DE CRÉATION DU MODÈLE"
        echo "============================================"
        python -c "from src.models.cnn_model import create_cnn_model; model = create_cnn_model(); print('✅ Modèle OK')"
    
    - name: Configuration de Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build de l'image de production
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: ${{ env.DOCKER_IMAGE }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Rapport de déploiement
      run: |
        echo "============================================"
        echo "DÉPLOIEMENT TERMINÉ"
        echo "============================================"
        echo "✅ Image Docker construite : ${{ env.DOCKER_IMAGE }}:latest"
        echo "✅ Commit : ${{ github.sha }}"
        echo "✅ Branche : ${{ github.ref }}"
        echo "============================================"
    
    - name: Création d'un artefact
      uses: actions/upload-artifact@v3
      with:
        name: deployment-info
        path: |
          config/config.yaml
          README.md